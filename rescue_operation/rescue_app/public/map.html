<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¿é›£æ‰€ãƒŠãƒ“ï¼ˆå¤§å®®åœ°åŒºï¼‰ - è‡ªæ²»ä¼šDX</title>
    
    <!-- Leaflet.jsï¼ˆç„¡æ–™ã®åœ°å›³ã‚·ã‚¹ãƒ†ãƒ ï¼‰ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #d32f2f;
            --accent: #fbc02d;
            --bg: #f4f7f9;
        }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #333; height: 100vh; display: flex; flex-direction: column; }
        
        header { background: var(--primary); color: white; padding: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 20; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.1rem; flex-grow: 1; }

        /* ç®¡ç†è€…ã‚¹ã‚¤ãƒƒãƒ */
        .admin-btn { font-size: 0.8rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); padding: 5px 10px; border-radius: 4px; color: white; cursor: pointer; }

        /* åœ°å›³æœ¬ä½“ */
        #map { flex: 1; width: 100%; z-index: 1; }
        .leaflet-bottom { z-index: 10 !important; }

        /* åœ°åŒºæ¤œç´¢ãƒãƒ¼ */
        .region-search-bar {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            z-index: 900;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            gap: 5px;
        }
        
        .region-select {
            flex: 1;
            padding: 10px;
            font-size: 1rem;
            border: 2px solid var(--primary);
            border-radius: 4px;
            background: #fff;
        }

        .search-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* é¿é›£æ‰€æƒ…å ±ã‚«ãƒ¼ãƒ‰ */
        .shelter-card {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%);
            width: 90%; max-width: 400px; background: white; border-radius: 12px;
            padding: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }
        .shelter-card.show { transform: translateX(-50%) translateY(0); }
        
        .shelter-name { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .shelter-info { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .shelter-badge { display: inline-block; background: #eee; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; color:#333; }

        .btn-route {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            text-decoration: none;
        }

        /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ */
        .gps-btn {
            position: absolute; bottom: 30px; right: 20px; z-index: 900;
            background: white; width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer; border: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç®¡ç†è€…ç”¨ï¼‰ */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none; z-index: 2000;
            align-items: center; justify-content: center;
        }
        .modal { background: white; padding: 25px; border-radius: 12px; width: 85%; max-width: 400px; }
        .modal input, .modal select { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        
        .gps-regist-btn {
            background: #e3f2fd; color: #0d47a1; border: 1px dashed #0d47a1;
            width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px;
            cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px;
        }

        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-modal { flex: 1; padding: 10px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }

        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 3000; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<header>
    <a href="index.html" style="color:white; text-decoration:none; font-size:1.2rem;">ğŸ </a>
    <h1>é¿é›£æ‰€ãƒŠãƒ“ (å¤§å®®åœ°åŒº)</h1>
    <button class="admin-btn" onclick="toggleAdmin()">âš™ï¸ ç®¡ç†è€…</button>
</header>

<!-- åœ°åŒºæ¤œç´¢ãƒãƒ¼ -->
<div class="region-search-bar">
    <select id="user-region" class="region-select">
        <option value="">ğŸ  ãŠä½ã¾ã„ã®åœ°åŒºã‚’é¸æŠ...</option>
        <option value="jingu">æ± å†…ãƒ»å—æ–¹ æ–¹é¢</option>
        <option value="ikeda">å¹³å’ŒãŒä¸˜ æ–¹é¢</option>
        <option value="hana">ç¥å®®ãƒ»ä¸‹åŒ—æ–¹ æ–¹é¢</option>
    </select>
    <button class="search-btn" onclick="searchByRegion()">ğŸ”</button>
</div>

<!-- åœ°å›³ã‚¨ãƒªã‚¢ -->
<div id="map"></div>

<!-- ç¾åœ¨åœ°ã¸ç§»å‹•ãƒœã‚¿ãƒ³ -->
<button class="gps-btn" onclick="locateUser()">ğŸ“</button>

<!-- é¿é›£æ‰€æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
<div class="shelter-card" id="shelter-card">
    <div class="shelter-name" id="card-name">é¿é›£æ‰€å</div>
    <div class="shelter-info">
        <span class="shelter-badge">å¯¾è±¡: <span id="card-region">-</span></span>
    </div>
    <div style="font-size:0.9rem; margin-bottom:10px;">
        ç¾åœ¨åœ°ã‹ã‚‰ã®ç›´ç·šè·é›¢ï¼š<strong id="card-dist">---</strong>
    </div>
    <!-- Googleãƒãƒƒãƒ—ã¸ã®ãƒªãƒ³ã‚¯ -->
    <a id="nav-link" href="#" target="_blank" class="btn-route">
        <span>ğŸš¶</span> Googleãƒãƒƒãƒ—ã§çµŒè·¯æ¡ˆå†…
    </a>
    <button onclick="closeCard()" style="width:100%; margin-top:10px; padding:8px; background:#eee; border:none; border-radius:6px;">é–‰ã˜ã‚‹</button>
</div>

<!-- ç®¡ç†è€…ç”¨ è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="admin-modal">
    <div class="modal">
        <h3>ğŸ“ åœ°ç‚¹ã‚’è¿½åŠ ï¼ˆç®¡ç†è€…ï¼‰</h3>
        
        <button class="gps-regist-btn" onclick="fillCurrentLocation()">
            <span>ğŸ“¡</span> ä»Šã„ã‚‹å ´æ‰€ã®åº§æ¨™ã‚’å–å¾—
        </button>

        <label style="font-size:0.8rem; font-weight:bold;">å ´æ‰€ã®ç¨®é¡</label>
        <select id="new-type">
            <option value="office">ğŸ¢ å½¹æ‰€ãƒ»äº‹å‹™æ‰€</option>
            <option value="school">ğŸ« é¿é›£æ‰€</option>
            <option value="water">ğŸ’§ çµ¦æ°´æ‰€ãƒ»äº•æˆ¸</option>
            <option value="danger">âš ï¸ å±é™ºç®‡æ‰€</option>
            <option value="store">ğŸ“¦ å‚™è“„å€‰åº«</option>
        </select>

        <input type="text" id="new-name" placeholder="åç§°ï¼ˆä¾‹ï¼šç¬¬1å‚™è“„å€‰åº«ï¼‰">
        <input type="text" id="new-region-tag" placeholder="å¯¾è±¡åœ°åŒºï¼ˆä¾‹ï¼šjinguï¼‰â€»ä»»æ„">
        
        <div style="display:flex; gap:5px;">
            <input type="text" id="new-lat" placeholder="ç·¯åº¦" readonly style="background:#f5f5f5; font-size:0.8rem;">
            <input type="text" id="new-lng" placeholder="çµŒåº¦" readonly style="background:#f5f5f5; font-size:0.8rem;">
        </div>

        <div class="modal-btns">
            <button class="btn-modal" style="background:#eee;" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn-modal" style="background:var(--primary); color:white;" onclick="savePin()">ä¿å­˜</button>
        </div>
    </div>
</div>

<div class="toast" id="toast">âœ… æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã—ãŸ</div>

<script>
    let map;
    let userMarker = null;
    let isAdmin = false;
    let tempLat = null;
    let tempLng = null;
    let userLat = null;
    let userLng = null;

    // â˜…â˜…â˜…ã“ã“ãŒåˆæœŸä½ç½®ï¼ˆå¤§å®®åœ°åŸŸäº‹å‹™æ‰€ï¼‰â˜…â˜…â˜…
    const CENTER_LAT = 31.945506824508666;
    const CENTER_LNG = 131.41746327456045;

    // å¤§å®®åœ°åŒºå‘¨è¾ºã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
    const pins = [
        // åœ°åŸŸäº‹å‹™æ‰€ï¼ˆä¸­å¿ƒï¼‰
        { type: 'office', name: 'å¤§å®®åœ°åŸŸäº‹å‹™æ‰€', lat: CENTER_LAT, lng: CENTER_LNG, targetRegion: '', regionName: 'æ‹ ç‚¹' },
        
        // å‘¨è¾ºæ–½è¨­ï¼ˆãƒ€ãƒŸãƒ¼ä½ç½®ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦å¾®èª¿æ•´ã—ã¦ãã ã•ã„ï¼‰
        { type: 'school', name: 'å¤§å®®å°å­¦æ ¡ ä½“è‚²é¤¨', lat: 31.9390, lng: 131.4240, targetRegion: 'jingu', regionName: 'å—æ–¹' },
        { type: 'school', name: 'å¤§å®®å…¬æ°‘é¤¨', lat: 31.9420, lng: 131.4260, targetRegion: 'hana', regionName: 'ä¸‹åŒ—æ–¹' },
        { type: 'store', name: 'å¹³å’ŒãŒä¸˜ å‚™è“„å€‰åº«', lat: 31.9550, lng: 131.4100, targetRegion: 'ikeda', regionName: 'å¹³å’ŒãŒä¸˜' },
        { type: 'water', name: 'ç½å®³å”åŠ›äº•æˆ¸ï¼ˆæ± ç”°å®…ï¼‰', lat: 31.9560, lng: 131.4110, targetRegion: 'ikeda', regionName: 'ç¥å®®' }
    ];

    function init() {
        // å¤§å®®åœ°åŸŸäº‹å‹™æ‰€ã‚’ä¸­å¿ƒåœ°å›³è¡¨ç¤º
        map = L.map('map').setView([CENTER_LAT, CENTER_LNG], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        renderPins();

        map.on('click', function(e) {
            if (isAdmin) {
                tempLat = e.latlng.lat;
                tempLng = e.latlng.lng;
                openModal(false);
            }
        });
    }

    function getIcon(type) {
        let emoji = 'ğŸ“';
        if (type === 'school') emoji = 'ğŸ«';
        if (type === 'water') emoji = 'ğŸ’§';
        if (type === 'danger') emoji = 'âš ï¸';
        if (type === 'store') emoji = 'ğŸ“¦';
        if (type === 'office') emoji = 'ğŸ¢';
        
        return L.divIcon({
            className: 'custom-icon',
            html: `<div style="font-size:2rem; text-shadow:0 2px 2px rgba(0,0,0,0.3);">${emoji}</div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 30]
        });
    }

    function renderPins() {
        pins.forEach(p => {
            const marker = L.marker([p.lat, p.lng], { icon: getIcon(p.type) }).addTo(map);
            marker.on('click', () => {
                showCard(p);
            });
            p.marker = marker;
        });
    }

    function searchByRegion() {
        const region = document.getElementById('user-region').value;
        if (!region) {
            alert("åœ°åŒºã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }

        const target = pins.find(p => p.type === 'school' && p.targetRegion === region);

        if (target) {
            map.setView([target.lat, target.lng], 16);
            showCard(target);
            target.marker.openPopup();
            showToast(`ğŸ  ${target.regionName} ã®é¿é›£æ‰€ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
        } else {
            alert("ãã®åœ°åŒºã®æŒ‡å®šé¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }
    }

    function locateUser() {
        if (!navigator.geolocation) { alert("GPSéå¯¾å¿œ"); return; }
        showToast("ğŸ“¡ GPSã§ç¾åœ¨åœ°ã‚’æ¸¬ä½ä¸­...");
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                userLat = pos.coords.latitude;
                userLng = pos.coords.longitude;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker([userLat, userLng], {
                    radius: 8, fillColor: "#2196f3", color: "#fff", weight: 2, fillOpacity: 1
                }).addTo(map);
                map.setView([userLat, userLng], 16);
                showToast("âœ… ç¾åœ¨åœ°ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
            },
            () => alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
        );
    }

    function showCard(data) {
        document.getElementById('card-name').innerText = data.name;
        document.getElementById('card-region').innerText = data.regionName || "å…¨åŸŸ";
        document.getElementById('shelter-card').classList.add('show');
        
        if (userLat) {
            const dist = map.distance([userLat, userLng], [data.lat, data.lng]);
            document.getElementById('card-dist').innerText = Math.round(dist) + " m";
            const link = `https://www.google.com/maps/dir/?api=1&destination=${data.lat},${data.lng}&travelmode=walking`;
            document.getElementById('nav-link').href = link;
        } else {
            document.getElementById('card-dist').innerText = "æœªå–å¾—";
            document.getElementById('nav-link').href = "#";
            document.getElementById('nav-link').onclick = function(e) {
                if(this.getAttribute('href') === "#") {
                    e.preventDefault();
                    alert("ã¾ãšå³ä¸‹ã®ğŸ“ãƒœã‚¿ãƒ³ã§ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„");
                }
            }
        }
    }

    function closeCard() { document.getElementById('shelter-card').classList.remove('show'); }

    function toggleAdmin() {
        isAdmin = !isAdmin;
        const btn = document.querySelector('.admin-btn');
        if (isAdmin) {
            btn.style.background = '#e91e63';
            showToast("ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ï¼šåœ°å›³ã‚¿ãƒƒãƒ—ã¾ãŸã¯GPSã§ç™»éŒ²å¯èƒ½");
        } else {
            btn.style.background = 'rgba(255,255,255,0.2)';
        }
    }

    function openModal(isGpsMode) {
        document.getElementById('admin-modal').style.display = 'flex';
        if (!isGpsMode && tempLat) {
            document.getElementById('new-lat').value = tempLat.toFixed(6);
            document.getElementById('new-lng').value = tempLng.toFixed(6);
        }
    }

    function fillCurrentLocation() {
        if (!navigator.geolocation) { alert("GPSä¸å¯"); return; }
        document.querySelector('.gps-regist-btn span').innerText = "â³ æ¸¬ä½ä¸­...";
        navigator.geolocation.getCurrentPosition((pos) => {
            document.getElementById('new-lat').value = pos.coords.latitude.toFixed(6);
            document.getElementById('new-lng').value = pos.coords.longitude.toFixed(6);
            document.querySelector('.gps-regist-btn span').innerText = "ğŸ“¡ å®Œäº†";
        });
    }

    function closeModal() {
        document.getElementById('admin-modal').style.display = 'none';
        document.getElementById('new-name').value = '';
        document.querySelector('.gps-regist-btn span').innerText = "ğŸ“¡ ä»Šã„ã‚‹å ´æ‰€ã®åº§æ¨™ã‚’å–å¾—";
    }

    function savePin() {
        const name = document.getElementById('new-name').value;
        const lat = parseFloat(document.getElementById('new-lat').value);
        const lng = parseFloat(document.getElementById('new-lng').value);
        const type = document.getElementById('new-type').value;
        const regionTag = document.getElementById('new-region-tag').value;

        if (name && lat && lng) {
            const newData = { name, lat, lng, type, targetRegion: regionTag, regionName: regionTag ? "æŒ‡å®šã‚ã‚Š" : "å…¨åŸŸ" };
            const marker = L.marker([lat, lng], { icon: getIcon(type) }).addTo(map);
            marker.on('click', () => showCard(newData));
            newData.marker = marker;
            pins.push(newData);

            showToast("âœ… åœ°ç‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸ");
            closeModal();
        } else {
            alert("åç§°ã¨åº§æ¨™ãŒå¿…è¦ã§ã™");
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    init();
</script>

</body>
</html>